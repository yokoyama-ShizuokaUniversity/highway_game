# 日本高速道路名前パズル

東名・新東名高速道路の区間を題材にした、IC/JCT/PA/SA/SIC 名を入力して高速道路を完成させるミニゲームのプロトタイプです。バックエンドは Python (Flask)、フロントエンドはシンプルな HTML/CSS/JavaScript で構成しています。

## セットアップと起動

1. 依存パッケージをインストールします。

   ```bash
   pip install -r requirements.txt
   ```

2. 開発サーバーを起動します。

   ```bash
   flask --app app run --debug
   ```

3. ブラウザで `http://127.0.0.1:5000` を開くとゲームが表示されます。

### エディター（開発用補助アプリ）

ゲームとは別プロセスのエディターを `http://127.0.0.1:5001` で動かし、作成した路線を JSON として `data/highways.json` に保存できます。

```bash
flask --app editor_app run --debug --port 5001
```

## 描画と配置ロジック（コードを読む前の概要）
- `static/script.js` で `/api/highways` から選択路線を取得し、`computeNormalizedNodes` で緯度経度を平面距離（haversine を使わない簡易換算）へ直し、0〜100% の座標に正規化しています。
- `applyDirectionalSpacing` で各区間の元の方向を保ったまま DISTANCE_SCALE 倍で伸ばしつつ、MIN_GAP 未満の区間は足し込み式で距離を底上げします。以前の全体スケーリング＋強制間隔が線を押し広げすぎて歪む原因だったため、方向ベクトルに沿った伸長へ変えています。
- `computeLabelOffsets` で道路の進行方向と直交方向ベクトルを求め、近いノードほどオフセットを大きくしつつ左右交互にラベル・入力欄をずらして重なりを回避します。
- セグメントはアイコン中心座標（%）を起点に絶対長さ(px)で作成し、`updateSegments` が両端が正解なら緑、そうでなければ灰色に塗り分けます。ノードとセグメントの z-index を分離し、線がアイコンや入力欄を邪魔しないようにしています。
- パンはズーム倍率を考慮した安全幅を計算し、左右上下のスライダーとボタンで `transform: translate(x,y) scale(z)` をかけ直すことで常に端点へ到達できるようにしています。

## 遊び方

- 上部のプルダウンで高速道路を選択し、「高速道路を選択」ボタンでロードします。東名／新東名のデモデータは `data/highways.json` から読み込みます。
- 各地点の下にある入力枠へ漢字で名称を入力します。データ上は「東京」「御殿場」「清水」など種別を含まない名称で管理しているため、末尾の「IC/JCT/SA/PA/SIC」を書いても書かなくても正解になります。正解するとアイコンが緑色に、両側が正解になると該当区間が緑色（#00b06b）で開通します。入力枠は線の向きに合わせてずらしつつ、間隔が詰まりそうな地点は最低距離を強制して広げています。
- 間違った場合はアイコンが赤くなり、区間は灰色のまま通行止めになります。
- 「すべてリセット」で初期状態に戻し、「ギブアップ」で答えが自動入力されます。拡大縮小スライダーで盤面を 70〜150% でズームし、左右・上下のパンはスライダーか矢印ボタンで視点を移動できます（→で右端、←で左端を見る方向）。距離感は緯度経度ベースでデフォルメしつつ広めに描画し、線分はアイコン同士を直接結びます。

## データ構造

- `/api/highways` で高速道路リスト、`/api/highways/<id>` で個別の路線データ（ノード一覧）を提供します。API 呼び出しごとに `data/highways.json` を読み直すため、エディターで保存した路線が即時反映されます。
- データソースは `data/highways.json`。座標はノードに `lat` / `lon` を付与すると実際の緯度経度距離に応じて自動で 0〜100% のデフォルメ座標へ正規化されます（欠けている場合は `x` `y` の既定値を利用）。線分は JSON の並び順で順につながります。東名は東京〜浜松西までの IC/JCT/PA/SA/SIC を収録済みです。
- ノード定義: `id`（ユニーク ID）、`name`（種別なしの地名のみ）、`kind`（IC/JCT/PA/SA/SIC）、`km`（任意の距離情報）、`lat` `lon`（緯度経度、推奨）、`x` `y`（0〜100 の相対座標の上書き用）、`connection_road`・`connection_cities`（JCT の接続道路名と主な接続都市）。入力時は種別を付けても省略しても認識されます。
- ランドマーク定義: `name`、`x` `y` に加え、`type` で `direction`（方面表示）、`city`（都市名）、`landform`（地形・地物など）の種別を指定できます。ゲーム上はアイコンとは無関係の淡色テキストとして描画されます。
- 複数路線を追加すれば選択肢を増やせる設計です。JSON に新しい路線を追記すればそのまま UI へ反映されます。

## 高速道路エディター

- `editor_app.py` を起動すると、起点都市・終点都市、IC/JCT/PA/SA/SIC の区分・名称（種別抜き地名）、緯度・経度、JCT の接続道路・接続都市を入力し、起点から最近傍の地点をたどる方式で自動並び替えを行います。
- 並べ替え結果は推定距離(km)とともに JSON スニペットとして表示され、「JSONを保存」ボタンから `data/highways.json` に上書き・追記できます（同じ id があれば置き換え）。

## 開発メモ

レビューブランチでコンフリクトが発生した場合は、以下の手順で自分側の変更を優先して解決できます。

```bash
git checkout --ours .
git add .
git commit -m "Fixed conflicts"
git push
```

本リポジトリでは main 直接更新も許容していますが、作業中ブランチで競合が出た際の参考として記載しています。

## ライセンス

このリポジトリは学習・デモ目的で提供されています。
